<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>ElasticStack-10-Elasticsearch篇之数据建模 | Startshineye的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本章会介绍使用 Elasticsearch 中要注意的数据建模常见问题以及优化思路和方案，让大家可以根据自己的业务场景设置最合理的模型。  
1.数据建模简介1.1 什么是数据建模?
1.英文为 Data Modeling,为创建数据模型的过程  
2.数据建模(Data Model)定义:-对现实世界进行抽象描述的一种工具和方法-通过抽像的实体及实体之间联系的形式去描述业务规则,从而实现对现实世">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticStack-10-Elasticsearch篇之数据建模">
<meta property="og:url" content="https://github.com/startshineye/2019/09/01/ElasticStack-10-Elasticsearch篇之数据建模/index.html">
<meta property="og:site_name" content="Startshineye的博客">
<meta property="og:description" content="本章会介绍使用 Elasticsearch 中要注意的数据建模常见问题以及优化思路和方案，让大家可以根据自己的业务场景设置最合理的模型。  
1.数据建模简介1.1 什么是数据建模?
1.英文为 Data Modeling,为创建数据模型的过程  
2.数据建模(Data Model)定义:-对现实世界进行抽象描述的一种工具和方法-通过抽像的实体及实体之间联系的形式去描述业务规则,从而实现对现实世">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/13.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/14.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/15.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/16.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/17.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/18.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/19.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/20.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/21.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/22.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/23.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/24.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/25.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/26.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/27.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/28.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/29.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/30.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/31.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/32.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/33.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/34.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/35.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/36.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/37.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/38.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/39.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/40.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/41.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/42.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/43.png">
<meta property="og:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/44.png">
<meta property="og:updated_time" content="2019-09-07T12:17:42.742Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ElasticStack-10-Elasticsearch篇之数据建模">
<meta name="twitter:description" content="本章会介绍使用 Elasticsearch 中要注意的数据建模常见问题以及优化思路和方案，让大家可以根据自己的业务场景设置最合理的模型。  
1.数据建模简介1.1 什么是数据建模?
1.英文为 Data Modeling,为创建数据模型的过程  
2.数据建模(Data Model)定义:-对现实世界进行抽象描述的一种工具和方法-通过抽像的实体及实体之间联系的形式去描述业务规则,从而实现对现实世">
<meta name="twitter:image" content="https://raw.githubusercontent.com/startshineye/img/master/2019/09/13.png">
  
    <link rel="alternative" href="/atom.xml" title="Startshineye的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			 <img src="https://raw.githubusercontent.com/startshineye/img/master/2017/king.jpg" class="js-avatar show">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Startshineye</a></h1>
		</hgroup>

		
		<p class="header-subtitle">淡泊明志，宁静致远</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/archives">所有文章</a></li>
	        
				<li><a href="/tags/随笔">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/startshineye" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
		        
					<a class="mail" target="_blank" href="#" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Startshineye</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="https://raw.githubusercontent.com/startshineye/img/master/2017/king.jpg" class="js-avatar show">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Startshineye</h1>
			</hgroup>
			
			<p class="header-subtitle">淡泊明志，宁静致远</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/startshineye" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="#" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-ElasticStack-10-Elasticsearch篇之数据建模" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ElasticStack-10-Elasticsearch篇之数据建模
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本章会介绍使用 Elasticsearch 中要注意的数据建模常见问题以及优化思路和方案，让大家可以根据自己的业务场景设置最合理的模型。  </p>
<h3 id="1-数据建模简介"><a href="#1-数据建模简介" class="headerlink" title="1.数据建模简介"></a>1.数据建模简介</h3><h4 id="1-1-什么是数据建模"><a href="#1-1-什么是数据建模" class="headerlink" title="1.1 什么是数据建模?"></a>1.1 什么是数据建模?</h4><ol>
<li>1.英文为 Data Modeling,为创建数据模型的过程  </li>
<li>2.数据建模(Data Model)定义:<br>-对现实世界进行抽象描述的一种工具和方法<br>-通过抽像的实体及实体之间联系的形式去描述业务规则,从而实现对现实世界的映射。  </li>
</ol>
<h4 id="1-2-数据建模的过程"><a href="#1-2-数据建模的过程" class="headerlink" title="1.2 数据建模的过程"></a>1.2 数据建模的过程</h4><ol>
<li>1.概念模型(10%)—确定需求<br>-确定系统的核心需求和范围边界,设计实体和实体间的关系。不会讨论具体的属性的。  </li>
<li>2.逻辑模型—根据需求,设计实体关系<br>-进一步梳理业务需求,确定每个实体的属性、关系和约束等。</li>
<li>3.物理模型—确认使用哪个数据库产品做<br>-结合具体的数据库产品,在满足业务读写性能等需求的前提下确定最终的定义。<br>-Mysql、MongoDB、elasticsearch等。<br>-第三范式<br>物理模型解决的问题其实是最终需要落地的东西。</li>
</ol>
<h4 id="1-3-数据建模的意义"><a href="#1-3-数据建模的意义" class="headerlink" title="1.3 数据建模的意义"></a>1.3 数据建模的意义</h4><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/13.png" alt=""><br>1.首先确认你的业务<br>2.其次你的系统数据支撑你的业务<br>3.系统数据需要怎样存储,就是需要考虑到数据模型了</p>
<h3 id="2-ES数据建模配置相关介绍"><a href="#2-ES数据建模配置相关介绍" class="headerlink" title="2.ES数据建模配置相关介绍"></a>2.ES数据建模配置相关介绍</h3><h4 id="2-1-ES的数据建模"><a href="#2-1-ES的数据建模" class="headerlink" title="2.1 ES的数据建模"></a>2.1 ES的数据建模</h4><ol>
<li>1.ES是基于Lucene以倒排索引为基础实现的存储体系,不遵循关系型数据库中的范式约定<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/14.png" alt="">  </li>
</ol>
<p>a.首先需要根据业务/数据需求来创建概念/逻辑模型,最后产出:实体列表、实体属性描述、实体键关系描述。<br>b.根据部署/性能需求产生物理模型,es中物理模型有ES Index Template、ES Index Mapping配置  </p>
<h4 id="2-2-Mapping字段的相关设置"><a href="#2-2-Mapping字段的相关设置" class="headerlink" title="2.2 Mapping字段的相关设置"></a>2.2 Mapping字段的相关设置</h4><ol>
<li><p>1.enabled<br>-true|false<br>-当字段仅存储,不做搜索或聚合分析,把这个值设置为false,默认为true,设置为false,节省磁盘空间，比如我们做外部系统请求分析时候、有一些cookie、session数据一般不做查询分析,此时把设置为false    </p>
</li>
<li><p>2.index<br>-true|false<br>-设置是否构建倒排索引  </p>
</li>
<li><p>3.index_options<br>-docs|freqs|positions|offsets<br>-如果构建倒排索引的话,需要存储哪些信息。  </p>
</li>
<li><p>4.norms<br>-true|false<br>-是否存储归一化相关参数,如果字段仅用于过滤和聚合分析,可关闭  </p>
</li>
<li><p>5.doc_values<br>-true| false<br>-是否启用doc_values,用于排序和聚合分析时候的场景  </p>
</li>
<li><p>6.field_data<br>-false|true<br>-是否为text类型启用fielddata,实现排序和聚合分析  </p>
</li>
<li><p>7.store<br>-false|true<br>-是否存储此字段值,默认为false,因为默认存放在source下  </p>
</li>
<li>8.coerce<br>-true|false<br>-是否开启自动数据类型转换功能,比如字符串转为数字,浮点转为整数等。  </li>
<li>9.multifields多字段<br>-灵活使用多字段特性来解决多样的业务需求  </li>
</ol>
<h4 id="2-3-Mapping的其他设置"><a href="#2-3-Mapping的其他设置" class="headerlink" title="2.3 Mapping的其他设置"></a>2.3 Mapping的其他设置</h4><ol>
<li><p>1.dynamic<br>-true|false|strict<br>-控制mapping自动更新  </p>
</li>
<li><p>2.data_detection<br>-true|false<br>-是否自动识别日期类型  </p>
</li>
</ol>
<h4 id="2-4-Mapping字段属性的设定流程"><a href="#2-4-Mapping字段属性的设定流程" class="headerlink" title="2.4 Mapping字段属性的设定流程"></a>2.4 Mapping字段属性的设定流程</h4><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/15.png" alt=""><br>一个设定的流程如下：<br>1.是何种类型  2.是否需要检索(index设定)   3.是否需要排序和聚合分析   4.是否需要另行存储  </p>
<h5 id="2-4-1-是何种类型"><a href="#2-4-1-是何种类型" class="headerlink" title="2.4.1 是何种类型?"></a>2.4.1 是何种类型?</h5><ol>
<li>1.字符串类型<br>-需要分词则设定为text类型,否则设定为keyword类型  </li>
<li>2.枚举类型<br>-基于性能考虑将其设置为keyword类型,即便该数据为整型。  </li>
<li>3.数值类型<br>-尽量选择贴近的类型,比如byte即可标识所有数值时,即选用byte,不要用long  </li>
<li>其他类型<br>-比如布尔类型、日期、地理位置数据等。  </li>
</ol>
<h5 id="2-4-2-是否需要检索"><a href="#2-4-2-是否需要检索" class="headerlink" title="2.4.2 是否需要检索?"></a>2.4.2 是否需要检索?</h5><ol>
<li>1.完全不需要检索、排序、聚合分析的字段<br>-enabled设置为false  </li>
<li>2.不需要检索的字段<br>-index设置为诶false  </li>
<li>3.需要检索的字段，可以通过如下配置设定需要的存储粒度<br>-index_options结合需要设定<br>-norms不需要归一化数据时关闭即可  </li>
</ol>
<h5 id="2-4-3-是否需要排序和聚合分析"><a href="#2-4-3-是否需要排序和聚合分析" class="headerlink" title="2.4.3 是否需要排序和聚合分析?"></a>2.4.3 是否需要排序和聚合分析?</h5><ol>
<li>1.不需要排序或者聚合分析 功能<br>-doc_vales设定为false<br>-fielddata设定为false  <h5 id="2-4-4-是否需要另行存储"><a href="#2-4-4-是否需要另行存储" class="headerlink" title="2.4.4 是否需要另行存储?"></a>2.4.4 是否需要另行存储?</h5></li>
<li>1.是否需要专门存储当前字段的数据?<br>-store设定为true,即可存储该字段的原始内容(与_source中的不相关)<br>-一般结合_source的enabled设定为false时使用  </li>
</ol>
<h3 id="3-ES数据建模实例"><a href="#3-ES数据建模实例" class="headerlink" title="3.ES数据建模实例"></a>3.ES数据建模实例</h3><p>我们结合博客文章blog_index为例来解析ES数据建模实例  </p>
<ol>
<li><p>1.博客文章blog_index<br>-标题title<br>-发布日期publish_data<br>-作者author<br>-摘要abstract<br>-网络地址url  </p>
</li>
<li><p>2.blog_index的mapping设置如下:<br>title:需要做全文检索的,所以为text类型,添加fields为keyword是为了满足title完全匹配,此时我们使用title.keyword时候就能完全匹配<br>publish_data:日期类型<br>author:不需要对author进行分词,所以设置为keyword<br>abstract:摘要进行全文检索的,所以分词<br>url:只做展示,不需要搜索url<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/16.png" alt=""></p>
</li>
<li><p>3.如果我们在博客中加入了content内容之后:博客文章blog_index<br>-标题title<br>-发布日期publish_data<br>-作者author<br>-摘要abstract<br>-内容content<br>-网络地址url<br>一个内容很大,几千字或者几万甚至几十万字,当内容很大时候,如果还是把content设置为text类型,当你取原始数据时候,通过_source获取原始内容,会取出很多内容,导致性能很慢，这个时候我们该如何解决这个问题,我们可以看下面的内容:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/17.png" alt=""></p>
</li>
</ol>
<p>a.首先我们把_source的enanbled设置为诶false(不需要把原始内容存放在_source里面了)<br>b.为每一个字段都加了”store”:true属性  </p>
<ol>
<li><p>4.一般我们做搜索引擎时候都有这样一个需求:匹配一个关键系之后,需要加一个高亮,以方便查看<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/18.png" alt=""><br>比如以下,我们搜索匹配content为包含word的文章,并且把content设置为高亮、我们在结果中不需要返回content的字段,这个时候设置返回的字段如下:”stored_fields”,如下直接返回title,publish_data,author,abstract,url  </p>
</li>
<li><p>5.kibana演示<br>-实例一:<br>a.创建索引  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">   put blog_index</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;:&#123;</div><div class="line">	  &quot;properties&quot;:&#123;</div><div class="line">	    &quot;title&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;text&quot;,</div><div class="line">		  &quot;fields&quot;:&#123;</div><div class="line">		     &quot;keyword&quot;:&#123;</div><div class="line">			   &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">			   &quot;ignore_above&quot;:100</div><div class="line">			 &#125;</div><div class="line">		  &#125;</div><div class="line">		&#125;,</div><div class="line">		&quot;publish_date&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;date&quot;</div><div class="line">		&#125;,</div><div class="line">		&quot;author&quot;:&#123;</div><div class="line">		   &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">		   &quot;ignore_above&quot;:100</div><div class="line">		&#125;,</div><div class="line">		&quot;abstract&quot;:&#123;</div><div class="line">		    &quot;type&quot;:&quot;text&quot;</div><div class="line">		&#125;,</div><div class="line">		&quot;url&quot;:&#123;</div><div class="line">		   &quot;enabled&quot;:false</div><div class="line">		&#125;,</div><div class="line">		&quot;content&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;text&quot;</div><div class="line">		&#125;</div><div class="line">	  &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>b.创建文档  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">     put blog_index/_doc/1</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:&quot;blog title&quot;,</div><div class="line">  &quot;content&quot;:&quot;blog content&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>c.查询创建的文档  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET blog_index/_search</div></pre></td></tr></table></figure>
</code></pre><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/19.png" alt=""><br>从上面看我们查询的文档内容在_source下<br>我们虽然可以通过以下查询直接指定source里面查询的内容:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/20.png" alt=""><br>但是我们知道es内部的运行机制,实际上在每一个node上都会把原始内容给取出来,只不过最终返回给用户的时候做了简单的过滤,对于以上查询对弈content也会在每一个node上查询返回,最终统一过滤。<br>我们如何用store设置为true来解决这个问题呢?<br>_source设置为false 则查询时候不会有值,每个字段添加store为true  </p>
<p>-实例二:<br>a.创建索引 </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">  </div><div class="line">     put blog_index</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;:&#123;</div><div class="line">    &quot;_source&quot;:&#123;</div><div class="line">      &quot;enabled&quot;:false</div><div class="line">    &#125;,</div><div class="line">	  &quot;properties&quot;:&#123;</div><div class="line">	    &quot;title&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;text&quot;,</div><div class="line">		  &quot;fields&quot;:&#123;</div><div class="line">		     &quot;keyword&quot;:&#123;</div><div class="line">			   &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">			   &quot;ignore_above&quot;:100</div><div class="line">			 &#125;</div><div class="line">		  &#125;,</div><div class="line">		  &quot;store&quot;:true</div><div class="line">		&#125;,</div><div class="line">		&quot;publish_date&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;date&quot;,</div><div class="line">		  &quot;store&quot;:true</div><div class="line">		&#125;,</div><div class="line">		&quot;author&quot;:&#123;</div><div class="line">		   &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">		   &quot;ignore_above&quot;:100,</div><div class="line">		   &quot;store&quot;:true</div><div class="line">		&#125;,</div><div class="line">		&quot;abstract&quot;:&#123;</div><div class="line">		    &quot;type&quot;:&quot;text&quot;,</div><div class="line">		    &quot;store&quot;:true</div><div class="line">		&#125;,</div><div class="line">		&quot;url&quot;:&#123;</div><div class="line">		    &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">		    &quot;doc_values&quot;:false,</div><div class="line">		    &quot;norms&quot;:false,</div><div class="line">		    &quot;ignore_above&quot;:100,</div><div class="line">		    &quot;store&quot;:true</div><div class="line">		&#125;,</div><div class="line">		&quot;content&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;text&quot;,</div><div class="line">		  &quot;store&quot;:true</div><div class="line">		&#125;</div><div class="line">	  &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>b.创建文档  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">     put blog_index/_doc/1</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:&quot;blog title&quot;,</div><div class="line">  &quot;content&quot;:&quot;blog content&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>c.查询创建的文档  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET blog_index/_search</div></pre></td></tr></table></figure>
</code></pre><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/21.png" alt=""> </p>
<p>d.查询  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   GET blog_index/_search</div><div class="line">&#123;</div><div class="line">  &quot;stored_fields&quot;: [&quot;title&quot;],</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;match&quot;: &#123;</div><div class="line">      &quot;content&quot;: &quot;blog&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;highlight&quot;: &#123;</div><div class="line">    &quot;fields&quot;: &#123;&quot;content&quot;:&#123;&#125;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/22.png" alt=""></p>
<h3 id="4-Nested-Object"><a href="#4-Nested-Object" class="headerlink" title="4.Nested_Object"></a>4.Nested_Object</h3><p>如何在es中处理关联关系,es不擅长处理关系型数据库中的关联关系,比如文章表blog与评论表comment之间通过blog_id关联,在es中可以通过如下两种手段变相解决(原因是es的底层实现是倒排索引,倒排索引不能做数据的联合的)<br>-Nested Object<br>-Parent/Child  </p>
<ol>
<li>1.比如我们的评论Comment<br>-文章Id blog_id<br>-评论人  username<br>-评论日期 date<br>-评论内容 content<br>如果在关数据库中实现的话,一般如下:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/23.png" alt="">  </li>
</ol>
<p>在es中我们直接把comments内容嵌入到Blog里面,这样获取blog内容时候,直接可以获取到评论comment如下:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/24.png" alt=""> </p>
<ol>
<li><p>2.对Blog做一个查询,如下:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/25.png" alt=""><br>这个查询条件的要求是:既给我返回用户名为lee并且评论内容为:thanks，发现返回的内容并不符合我们的要求。原因如下：  </p>
</li>
<li><p>3.Comments默认是Object Array,存储结构类似下面的形式:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/26.png" alt=""><br>如何解决上面问题呢?es提出了Nested Object<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/27.png" alt="">  </p>
</li>
</ol>
<p>此时对Nested Object做查询时候,需要指定nested关键字,然后path里面添加Nested Object里面的关键字comments,然后哦<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/28.png" alt=""> </p>
<p>为什么Nested Object能够解决这个问题呢?是因为:把nested修饰的内容对立存储  </p>
<ol>
<li><p>4.Nested Object Array的存储结构类似下面形式：<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/29.png" alt="">  </p>
</li>
<li><p>5.kibana演示<br>-不加nested查询<br>a.新建blog_index下文档,把comments放在文档里面  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   PUT blog_index/_doc/2</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:&quot;Blog Number One&quot;,</div><div class="line">  &quot;author&quot;:&quot;alfred&quot;,</div><div class="line">  &quot;comments&quot;:[</div><div class="line">    &#123;</div><div class="line">      &quot;username&quot;:&quot;lee&quot;,</div><div class="line">      &quot;date&quot;:&quot;2017-01-02&quot;,</div><div class="line">      &quot;content&quot;:&quot;awesome article!&quot;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;username&quot;:&quot;fax&quot;,</div><div class="line">      &quot;date&quot;:&quot;2017-04-02&quot;,</div><div class="line">      &quot;content&quot;:&quot;thanks&quot;</div><div class="line">    &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>b.做一个文档查询  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   GET blog_index/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;bool&quot;: &#123;</div><div class="line">      &quot;must&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;match&quot;: &#123;</div><div class="line">            &quot;comments.username&quot;: &quot;lee&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;match&quot;: &#123;</div><div class="line">            &quot;comments.content&quot;: &quot;thanks&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/30.png" alt=""></p>
<p>-加入nested查询<br>a.创建索引(注意创建索引时候comments的类型是nested)    </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   PUT blog_index_nested</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;:&#123;</div><div class="line">	  &quot;properties&quot;:&#123;</div><div class="line">	    &quot;title&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;text&quot;,</div><div class="line">		  &quot;fields&quot;:&#123;</div><div class="line">		     &quot;keyword&quot;:&#123;</div><div class="line">			   &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">			   &quot;ignore_above&quot;:100</div><div class="line">			 &#125;</div><div class="line">		  &#125;</div><div class="line">		&#125;,</div><div class="line">		&quot;publish_date&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;date&quot;</div><div class="line">		&#125;,</div><div class="line">		&quot;author&quot;:&#123;</div><div class="line">		   &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">		   &quot;ignore_above&quot;:100</div><div class="line">		&#125;,</div><div class="line">		&quot;abstract&quot;:&#123;</div><div class="line">		    &quot;type&quot;:&quot;text&quot;</div><div class="line">		&#125;,</div><div class="line">		&quot;url&quot;:&#123;</div><div class="line">		   &quot;enabled&quot;:false</div><div class="line">		&#125;,</div><div class="line">		&quot;content&quot;:&#123;</div><div class="line">		  &quot;type&quot;:&quot;text&quot;</div><div class="line">		&#125;,</div><div class="line">		&quot;comments&quot;:&#123;</div><div class="line">		  &quot;type&quot;: &quot;nested&quot;,</div><div class="line">		  &quot;properties&quot;: &#123;</div><div class="line">		    &quot;username&quot;:&#123;</div><div class="line">		      &quot;type&quot;:&quot;keyword&quot;,</div><div class="line">		      &quot;ignore_above&quot;:100</div><div class="line">		    &#125;,</div><div class="line">		    &quot;date&quot;:&#123;</div><div class="line">		      &quot;type&quot;:&quot;date&quot;</div><div class="line">		    &#125;,</div><div class="line">		    &quot;content&quot;:&#123;</div><div class="line">		      &quot;type&quot;:&quot;text&quot;</div><div class="line">		    &#125;</div><div class="line">		  &#125;</div><div class="line">		 &#125;</div><div class="line">	  &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>b.创建文档  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   PUT blog_index_nested/_doc/2</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:&quot;Blog Number One&quot;,</div><div class="line">  &quot;author&quot;:&quot;alfred&quot;,</div><div class="line">  &quot;comments&quot;:[</div><div class="line">    &#123;</div><div class="line">      &quot;username&quot;:&quot;lee&quot;,</div><div class="line">      &quot;date&quot;:&quot;2017-01-02&quot;,</div><div class="line">      &quot;content&quot;:&quot;awesome article!&quot;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;username&quot;:&quot;fax&quot;,</div><div class="line">      &quot;date&quot;:&quot;2017-04-02&quot;,</div><div class="line">      &quot;content&quot;:&quot;thanks&quot;</div><div class="line">    &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>c.查询(用nested查询)  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   GET blog_index_nested/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;nested&quot;: &#123;</div><div class="line">      &quot;path&quot;: &quot;comments&quot;,</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;bool&quot;: &#123;</div><div class="line">          &quot;must&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;match&quot;: &#123;</div><div class="line">                &quot;comments.username&quot;: &quot;lee&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">              &quot;match&quot;: &#123;</div><div class="line">                &quot;comments.content&quot;: &quot;thanks&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/31.png" alt="">  </p>
<h3 id="5-Parent-Child"><a href="#5-Parent-Child" class="headerlink" title="5.Parent_Child"></a>5.Parent_Child</h3><h4 id="5-1-Parent-Child理论"><a href="#5-1-Parent-Child理论" class="headerlink" title="5.1 Parent_Child理论"></a>5.1 Parent_Child理论</h4><ol>
<li>1.ES还提供了类似关系型库中join的实现方式,使用join数据类型实现<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/32.png" alt=""><br>a.以上使用关键字:join<br>b.指明类型:join<br>c.relations指明父子关系<br>d.blog代表父,comment代表子  </li>
</ol>
<p>join是在es6.x才有的<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/33.png" alt=""> </p>
<ol>
<li><p>2.常见query语法包括如下几种:<br>-parent_id返回某父文档的子文档<br>-has_child返回包含某子文档的父文档<br>-has_parent返回包含某父文档的子文档  </p>
</li>
<li><p>3.parent_id查询:返回某父文档的子文档<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/34.png" alt=""> </p>
</li>
<li><p>4.has_child查询:返回包含某子文档的父文档<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/35.png" alt="">  </p>
</li>
<li><p>5.has_parent查询:返回包含某父文档的子文档<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/36.png" alt="">  </p>
</li>
</ol>
<h4 id="5-2-Kibana演示"><a href="#5-2-Kibana演示" class="headerlink" title="5.2 Kibana演示"></a>5.2 Kibana演示</h4><ol>
<li><p>1.创建索引  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">   PUT blog_index_parent_child</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;properties&quot;: &#123;</div><div class="line">      &quot;join&quot;:&#123;</div><div class="line">        &quot;type&quot;: &quot;join&quot;,</div><div class="line">        &quot;relations&quot;:&#123;</div><div class="line">          &quot;blog&quot;:&quot;comment&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>2.创建文档<br>a.创建父文档  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">    </div><div class="line">    PUT blog_index_parent_child/_doc/1</div><div class="line"> &#123;</div><div class="line">   &quot;title&quot;:&quot;blog&quot;,</div><div class="line">   &quot;join&quot;:&quot;blog&quot;</div><div class="line"> &#125;</div><div class="line"></div><div class="line">   PUT blog_index_parent_child/_doc/2</div><div class="line">&#123;</div><div class="line">  &quot;title&quot;:&quot;blog2&quot;,</div><div class="line">  &quot;join&quot;:&quot;blog&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>b.创建子文档:子文档和父文档在同一个index下  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   </div><div class="line">     PUT blog_index_parent_child/_doc/comment-1?routing=1</div><div class="line">&#123;</div><div class="line">  &quot;comment&quot;:&quot;comment world&quot;,</div><div class="line">  &quot;join&quot;:&#123;</div><div class="line">    &quot;name&quot;:&quot;comment&quot;,</div><div class="line">    &quot;parent&quot;:1</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PUT blog_index_parent_child/_doc/comment-2?routing=2</div><div class="line">&#123;</div><div class="line">  &quot;comment&quot;:&quot;comment hello&quot;,</div><div class="line">  &quot;join&quot;:&#123;</div><div class="line">    &quot;name&quot;:&quot;comment&quot;,</div><div class="line">    &quot;parent&quot;:2</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>3.查询文档<br>a.查询所有文档  </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">    </div><div class="line">GET blog_index_parent_child/_search</div></pre></td></tr></table></figure>
</li>
</ol>
<p>结果为:   </p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">    </div><div class="line">   &#123;</div><div class="line">  &quot;took&quot; : 1046,</div><div class="line">  &quot;timed_out&quot; : false,</div><div class="line">  &quot;_shards&quot; : &#123;</div><div class="line">    &quot;total&quot; : 1,</div><div class="line">    &quot;successful&quot; : 1,</div><div class="line">    &quot;skipped&quot; : 0,</div><div class="line">    &quot;failed&quot; : 0</div><div class="line">  &#125;,</div><div class="line">  &quot;hits&quot; : &#123;</div><div class="line">    &quot;total&quot; : &#123;</div><div class="line">      &quot;value&quot; : 4,</div><div class="line">      &quot;relation&quot; : &quot;eq&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;max_score&quot; : 1.0,</div><div class="line">    &quot;hits&quot; : [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot; : &quot;blog_index_parent_child&quot;,</div><div class="line">        &quot;_type&quot; : &quot;_doc&quot;,</div><div class="line">        &quot;_id&quot; : &quot;1&quot;,</div><div class="line">        &quot;_score&quot; : 1.0,</div><div class="line">        &quot;_source&quot; : &#123;</div><div class="line">          &quot;title&quot; : &quot;blog&quot;,</div><div class="line">          &quot;join&quot; : &quot;blog&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot; : &quot;blog_index_parent_child&quot;,</div><div class="line">        &quot;_type&quot; : &quot;_doc&quot;,</div><div class="line">        &quot;_id&quot; : &quot;2&quot;,</div><div class="line">        &quot;_score&quot; : 1.0,</div><div class="line">        &quot;_source&quot; : &#123;</div><div class="line">          &quot;title&quot; : &quot;blog2&quot;,</div><div class="line">          &quot;join&quot; : &quot;blog&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot; : &quot;blog_index_parent_child&quot;,</div><div class="line">        &quot;_type&quot; : &quot;_doc&quot;,</div><div class="line">        &quot;_id&quot; : &quot;comment-1&quot;,</div><div class="line">        &quot;_score&quot; : 1.0,</div><div class="line">        &quot;_routing&quot; : &quot;1&quot;,</div><div class="line">        &quot;_source&quot; : &#123;</div><div class="line">          &quot;comment&quot; : &quot;comment world&quot;,</div><div class="line">          &quot;join&quot; : &#123;</div><div class="line">            &quot;name&quot; : &quot;comment&quot;,</div><div class="line">            &quot;parent&quot; : 1</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot; : &quot;blog_index_parent_child&quot;,</div><div class="line">        &quot;_type&quot; : &quot;_doc&quot;,</div><div class="line">        &quot;_id&quot; : &quot;comment-2&quot;,</div><div class="line">        &quot;_score&quot; : 1.0,</div><div class="line">        &quot;_routing&quot; : &quot;2&quot;,</div><div class="line">        &quot;_source&quot; : &#123;</div><div class="line">          &quot;comment&quot; : &quot;comment hello&quot;,</div><div class="line">          &quot;join&quot; : &#123;</div><div class="line">            &quot;name&quot; : &quot;comment&quot;,</div><div class="line">            &quot;parent&quot; : 2</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>b.返回父文档id=2的子文档<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/37.png" alt=""></p>
<p>c.返回包含子文档的父文档<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/38.png" alt="">  </p>
<h3 id="6-nested-vs-parent-child"><a href="#6-nested-vs-parent-child" class="headerlink" title="6.nested_vs_parent_child"></a>6.nested_vs_parent_child</h3><p>nested Object和parent_child对比如下:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/39.png" alt=""> </p>
<h3 id="7-reindex"><a href="#7-reindex" class="headerlink" title="7.reindex"></a>7.reindex</h3><ol>
<li><p>1.reindex指重建所有数据的过程,一般发生在如下情况:<br>-mapping设置变更,比如字段类型变化、分词器字典更新等<br>-index设置变更,比如分片数更改等<br>-迁移数据  </p>
</li>
<li><p>2.ES提供了现成的API用于完成改工作<br>-_update_by_query在现有索引上重建<br>-_reindex在其他索引上重建  </p>
</li>
</ol>
<h4 id="7-1-update-by-query"><a href="#7-1-update-by-query" class="headerlink" title="7.1 _update_by_query"></a>7.1 _update_by_query</h4><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/40.png" alt=""></p>
<h4 id="7-2-reindex"><a href="#7-2-reindex" class="headerlink" title="7.2 _reindex"></a>7.2 _reindex</h4><p>a._reindex将源目标的数据重建到dest中<br>b._reindex除了在同一个集群里面,还支持在远程的集群。<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/41.png" alt=""><br>上面是把blog_index的索引重建到blog_new_index索引里面  </p>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/42.png" alt="">  </p>
<h4 id="7-3-Task"><a href="#7-3-Task" class="headerlink" title="7.3 Task"></a>7.3 Task</h4><ol>
<li>1.数据重建的时间受源索引文档规模的影响,当规模越大时,所需要时间越多,此时需要通过设定url参数wait_for_completion为false来异步执行,ES以task来描述此类执行任务  </li>
<li>ES提供了Task API来查看任务的执行进度和相关数据<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/43.png" alt=""></li>
</ol>
<h3 id="8-其他建议"><a href="#8-其他建议" class="headerlink" title="8.其他建议"></a>8.其他建议</h3><h4 id="8-1-数据模型版本管理"><a href="#8-1-数据模型版本管理" class="headerlink" title="8.1.数据模型版本管理"></a>8.1.数据模型版本管理</h4><ol>
<li>1.对Mapping进行版本管理<br>-包含在代码或者以专门的文件进行管理,添加好注释,并加入Git等版本管理仓库中,方便回顾<br>-为每个增加一个metadata字段,在其中维护一些文档相关的元数据,方便对数据进行管理<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2019/09/44.png" alt="">  </li>
</ol>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2019/09/01/ElasticStack-10-Elasticsearch篇之数据建模/" class="archive-article-date">
  	<time datetime="2019-09-01T15:31:54.000Z" itemprop="datePublished"><i class="icon-clock"></i>2019-09-01</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ElasticStack/">ElasticStack</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
  
    <a href="/2019/08/24/ElasticStack-9-Elasticsearch篇之聚合分析入门/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">ElasticStack-9-Elasticsearch篇之聚合分析入门</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>




<div class="share_addthis share_jia">
  <div class="sharing addthis_toolbox share">
  	<span class="jiathis_txt">Share to: &nbsp; </span>
    <a class="addthis_button_facebook_like"></a>
    <a class="addthis_button_tweet"></a>
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-560c64c35486b3d4" async="async"></script>
</div>




<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="ElasticStack-10-Elasticsearch篇之数据建模" data-title="ElasticStack-10-Elasticsearch篇之数据建模" data-url="https://github.com/startshineye/2019/09/01/ElasticStack-10-Elasticsearch篇之数据建模/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 Startshineye
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/CTI/" style="font-size: 11.11px;">CTI</a> <a href="/tags/Cookie/" style="font-size: 10.56px;">Cookie</a> <a href="/tags/DevelopmentSkills/" style="font-size: 10px;">DevelopmentSkills</a> <a href="/tags/Easyui/" style="font-size: 10px;">Easyui</a> <a href="/tags/ElasticStack/" style="font-size: 14.44px;">ElasticStack</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Http/" style="font-size: 10px;">Http</a> <a href="/tags/IE问题/" style="font-size: 10px;">IE问题</a> <a href="/tags/JDK/" style="font-size: 10px;">JDK</a> <a href="/tags/JSP/" style="font-size: 10px;">JSP</a> <a href="/tags/JVM/" style="font-size: 12.22px;">JVM</a> <a href="/tags/JavaSE/" style="font-size: 15.56px;">JavaSE</a> <a href="/tags/Jeecg/" style="font-size: 11.67px;">Jeecg</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Myeclipse/" style="font-size: 14.44px;">Myeclipse</a> <a href="/tags/Netty/" style="font-size: 16.67px;">Netty</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/Oracle/" style="font-size: 16.67px;">Oracle</a> <a href="/tags/Redis/" style="font-size: 12.22px;">Redis</a> <a href="/tags/Servlet/" style="font-size: 11.67px;">Servlet</a> <a href="/tags/Spring/" style="font-size: 10.56px;">Spring</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring Boot</a> <a href="/tags/SpringBoot/" style="font-size: 19.44px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 12.22px;">SpringCloud</a> <a href="/tags/SpringMVC/" style="font-size: 11.11px;">SpringMVC</a> <a href="/tags/Tomcat/" style="font-size: 10px;">Tomcat</a> <a href="/tags/Vue/" style="font-size: 18.89px;">Vue</a> <a href="/tags/Vue-js-前端开发-快速入门与专业应用/" style="font-size: 17.22px;">Vue.js+前端开发+快速入门与专业应用</a> <a href="/tags/Weblogic/" style="font-size: 12.22px;">Weblogic</a> <a href="/tags/Websocket/" style="font-size: 10.56px;">Websocket</a> <a href="/tags/Work-Problem/" style="font-size: 10px;">Work-Problem</a> <a href="/tags/bg/" style="font-size: 10px;">bg</a> <a href="/tags/c/" style="font-size: 10.56px;">c</a> <a href="/tags/crawler/" style="font-size: 17.78px;">crawler</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/easyui/" style="font-size: 10px;">easyui</a> <a href="/tags/freeswitch/" style="font-size: 10px;">freeswitch</a> <a href="/tags/hibernate/" style="font-size: 10.56px;">hibernate</a> <a href="/tags/html-css/" style="font-size: 10.56px;">html+css</a> <a href="/tags/html-css/" style="font-size: 15.56px;">html-css</a> <a href="/tags/html-ss/" style="font-size: 10px;">html-ss</a> <a href="/tags/im/" style="font-size: 13.89px;">im</a> <a href="/tags/ipcc/" style="font-size: 10.56px;">ipcc</a> <a href="/tags/jQuery/" style="font-size: 12.22px;">jQuery</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/java-String/" style="font-size: 10px;">java String</a> <a href="/tags/javaSE/" style="font-size: 10.56px;">javaSE</a> <a href="/tags/javaWeb/" style="font-size: 10px;">javaWeb</a> <a href="/tags/javascript/" style="font-size: 11.11px;">javascript</a> <a href="/tags/java并发编程/" style="font-size: 11.67px;">java并发编程</a> <a href="/tags/java集合/" style="font-size: 10.56px;">java集合</a> <a href="/tags/junit测试/" style="font-size: 10px;">junit测试</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/log4j/" style="font-size: 11.67px;">log4j</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/netty/" style="font-size: 11.67px;">netty</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/nodeJs/" style="font-size: 10px;">nodeJs</a> <a href="/tags/redis/" style="font-size: 12.78px;">redis</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/shiro/" style="font-size: 12.78px;">shiro</a> <a href="/tags/sockJs/" style="font-size: 10px;">sockJs</a> <a href="/tags/socket网络编程/" style="font-size: 10.56px;">socket网络编程</a> <a href="/tags/struts1/" style="font-size: 11.11px;">struts1</a> <a href="/tags/vue/" style="font-size: 10.56px;">vue</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/weblogic/" style="font-size: 11.11px;">weblogic</a> <a href="/tags/websocket/" style="font-size: 16.11px;">websocket</a> <a href="/tags/work/" style="font-size: 15px;">work</a> <a href="/tags/zyzx/" style="font-size: 18.33px;">zyzx</a> <a href="/tags/代理/" style="font-size: 11.67px;">代理</a> <a href="/tags/前端/" style="font-size: 10.56px;">前端</a> <a href="/tags/动手写一个MVC/" style="font-size: 12.22px;">动手写一个MVC</a> <a href="/tags/反射/" style="font-size: 16.11px;">反射</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/微博/" style="font-size: 10px;">微博</a> <a href="/tags/文件读取/" style="font-size: 10px;">文件读取</a> <a href="/tags/泛型/" style="font-size: 13.33px;">泛型</a> <a href="/tags/注解/" style="font-size: 11.11px;">注解</a> <a href="/tags/类加载器/" style="font-size: 13.33px;">类加载器</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a> <a href="/tags/自己写一个apache服务器/" style="font-size: 16.67px;">自己写一个apache服务器</a> <a href="/tags/转载/" style="font-size: 12.22px;">转载</a> <a href="/tags/集合/" style="font-size: 12.22px;">集合</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.baidu.com/">baidu</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jd.com/">jd</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">毕业于&lt;br&gt;相信技术可以改变人与人之间的生活&lt;br&gt;码农一枚</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>