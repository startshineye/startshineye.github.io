<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Startshineye的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="毕业于石大，相信技术可以改变人与人之间的生活，码农一枚">
<meta property="og:type" content="website">
<meta property="og:title" content="Startshineye的博客">
<meta property="og:url" content="https://github.com/startshineye/index.html">
<meta property="og:site_name" content="Startshineye的博客">
<meta property="og:description" content="毕业于石大，相信技术可以改变人与人之间的生活，码农一枚">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Startshineye的博客">
<meta name="twitter:description" content="毕业于石大，相信技术可以改变人与人之间的生活，码农一枚">
  
    <link rel="alternative" href="/atom.xml" title="Startshineye的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			 <img src="https://raw.githubusercontent.com/startshineye/img/master/2017/king.jpg" class="js-avatar show">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Startshineye</a></h1>
		</hgroup>

		
		<p class="header-subtitle">淡泊明志，宁静致远</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/archives">所有文章</a></li>
	        
				<li><a href="/tags/随笔">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/startshineye" title="github">github</a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
		        
					<a class="rss" target="_blank" href="#" title="rss">rss</a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
		        
					<a class="mail" target="_blank" href="#" title="mail">mail</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Startshineye</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="https://raw.githubusercontent.com/startshineye/img/master/2017/king.jpg" class="js-avatar show">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Startshineye</h1>
			</hgroup>
			
			<p class="header-subtitle">淡泊明志，宁静致远</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/startshineye" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="#" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-SpringCloudAlibaba-19-seata分布式事务解决方案AT" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/06/SpringCloudAlibaba-19-seata分布式事务解决方案AT/">SpringCloudAlibaba-19-seata分布式事务解决方案AT</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>参考：<a href="https://www.jianshu.com/p/940e2cfab67e" target="_blank" rel="external">https://www.jianshu.com/p/940e2cfab67e</a><br>quickstart:<a href="https://seata.io/zh-cn/docs/user/quickstart.html" target="_blank" rel="external">https://seata.io/zh-cn/docs/user/quickstart.html</a>  </p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><h4 id="1-seata简介"><a href="#1-seata简介" class="headerlink" title="1.seata简介"></a>1.seata简介</h4><p>Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/42.png" alt=""><br>TM:transaction manager<br>RM:resource manager  </p>
<p>1）TM：事务的发起者。用来告诉 TC，全局事务的开始，提交，回滚。<br>2）RM：具体的事务资源，每一个 RM 都会作为一个分支事务注册在 TC。<br>3）TC 事务的协调者。也可以看做是 Fescar-server，用于接收我们的事务的注册，提交和回滚。  </p>
<h4 id="2-实战"><a href="#2-实战" class="headerlink" title="2.实战"></a>2.实战</h4><h5 id="2-1-准备"><a href="#2-1-准备" class="headerlink" title="2.1 准备"></a>2.1 准备</h5><ol>
<li>1.我们从github上下载seata应用jar包  </li>
</ol>
<ol>
<li>2.在本地数据源数据库中添加seata的undo_log日志(在alibaba-order,alibaba-pay库里面)  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `undo_log` (</div><div class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</div><div class="line">  `branch_id` bigint(20) NOT NULL,</div><div class="line">  `xid` varchar(100) NOT NULL,</div><div class="line">  `context` varchar(128) NOT NULL,</div><div class="line">  `rollback_info` longblob NOT NULL,</div><div class="line">  `log_status` int(11) NOT NULL,</div><div class="line">  `log_created` datetime NOT NULL,</div><div class="line">  `log_modified` datetime NOT NULL,</div><div class="line">  `ext` varchar(100) DEFAULT NULL,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure>
<ol>
<li>3.需要使用tc，则需要启动,点击:seata-server.bat  </li>
</ol>
<h5 id="2-2-工程集成"><a href="#2-2-工程集成" class="headerlink" title="2.2 工程集成"></a>2.2 工程集成</h5><ol>
<li>1.引入依赖(3个服务都添加)    </li>
</ol>
<pre><code>&lt;dependency&gt;
       &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
       &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
       &lt;version&gt;2.1.1.RELEASE&lt;/version&gt;
   &lt;/dependency&gt;
</code></pre><ol>
<li><p>2.所有的资源服务中加入register,conf,因为服务端,客户端都需要注册,以及客户端配置;存放到resources目录下  </p>
</li>
<li><p>3.我们是在biz-service上开启一个全局的事物来管理:pay-service和order-service；所以需要在biz-service的对应业务层加一个全局的事务注解: @GlobalTransactional(在最早的服务上加这个注解就可以了)  </p>
</li>
<li><p>4.pay/order服务里面的jdbc是spring自己的数据源，这个时候,其实还没有完,我们需要使用seata来代理各个服务的数据源</p>
</li>
<li><p>5.启动biz-service时候报错,<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/43.png" alt=""><br>我们需要在file里面配置group,规则:appliactionname-seata-service-group  </p>
</li>
<li><p>6.测试访问biz-service<br>我们重启:biz-service,然后访问:<a href="http://127.0.0.1:8010/biz" target="_blank" rel="external">http://127.0.0.1:8010/biz</a><br>此时pay/order服务已经没有插入了数据  </p>
</li>
</ol>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/06/SpringCloudAlibaba-19-seata分布式事务解决方案AT/" class="archive-article-date">
  	<time datetime="2020-02-06T00:53:38.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-06</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-18-seata分布式事务问题回显" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/05/SpringCloudAlibaba-18-seata分布式事务问题回显/">SpringCloudAlibaba-18-seata分布式事务问题回显</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本节介绍SpringCloudAlibaba中分布式事务解决方案seta,首先我们不介绍seta,我们先模拟分布式事务这个问题。  </p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><p>我们以案例出发,支付场景案例如下:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/40.png" alt="">  </p>
<p>a.首先支付请求进来以后,经过我们的biz-service(前面的业务处理)对参数进行校验，校验完之后调用我们的订单服务:order-service统一下单,下单完之后,调用我们的支付服务pay-service去调用三方接口,在这个地方:order-service和pay-service都会操作自己的数据库,操作完之后通过biz-service给用户返回一个请求。那么这里有三个微服务，本节我们就实现这3个微服务。  </p>
<h4 id="1-创建3个服务"><a href="#1-创建3个服务" class="headerlink" title="1.创建3个服务"></a>1.创建3个服务</h4><ol>
<li>1.创建3个服务  </li>
<li>2.修改对应端口为上图所示  </li>
<li>3.3个服务创建完毕,我们需要让order(alibaba-order)和pay(alibaba-pay)服务能够操作单独的数据库。   </li>
<li>4.数据库脚本为:  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `order/pay` (</div><div class="line">  `id` int(11) DEFAULT NULL,</div><div class="line">  `username` varchar(20) DEFAULT NULL COMMENT &apos;用户名&apos;</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</div></pre></td></tr></table></figure>
<ol>
<li>5.操作数据库插入数据  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Service</div><div class="line">public class OrderService &#123;</div><div class="line">    @Autowired</div><div class="line">    private JdbcTemplate jdbcTemplate;</div><div class="line">    @Transactional</div><div class="line">    public void save()&#123;</div><div class="line">        jdbcTemplate.update(&quot;INSERT INTO `order`( `username`) VALUES (&apos;123&apos;);&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">```</div></pre></td></tr></table></figure>
<p>@Service<br>public class PayService {<br>    @Autowired<br>    private JdbcTemplate jdbcTemplate;<br>    @Transactional<br>    public void save(){<br>        jdbcTemplate.update(“INSERT INTO <code>pay</code>( <code>username</code>) VALUES (‘123’);”);<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">6. 6.order/pay-service服务提供给biz-service访问的接口</div></pre></td></tr></table></figure></p>
<p>@RestController<br>public class OrderController {<br>    @Autowired<br>    private OrderService orderService;<br>    @GetMapping(“/order”)<br>    public String order(){<br>        orderService.save();<br>        return “success”;<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>@RestController<br>public class PayController {<br>    @Autowired<br>    private PayService payService;<br>    @GetMapping(“/pay”)<br>    public String pay(){<br>       payService.save();<br>       return “success”;<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">#### 2.biz服务调用其他服务</div><div class="line">我们使用spring自带的RestTemplate模板  </div><div class="line"></div><div class="line">1. 1.创建service</div></pre></td></tr></table></figure></p>
<p>@Service<br>public class BizService {<br>    @Autowired<br>    private RestTemplate restTemplate;<br>    @Transactional<br>    public void biz(){<br>        //order<br>        restTemplate.getForObject(“<a href="http://127.0.0.1:8020/order&quot;,String.class" target="_blank" rel="external">http://127.0.0.1:8020/order&quot;,String.class</a>);<br>        //pay<br>        restTemplate.getForObject(“<a href="http://127.0.0.1:8030/pay&quot;,String.class" target="_blank" rel="external">http://127.0.0.1:8030/pay&quot;,String.class</a>);<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">2. 2.创建controller</div></pre></td></tr></table></figure></p>
<p>@RestController<br>public class BizController {<br>    @Autowired<br>    private BizService bizService;<br>    @GetMapping(“/biz”)<br>    public String biz(){<br>        bizService.biz();<br>        return “success”;<br>    }<br>}<br>```</p>
<ol>
<li>3.重启3个服务<br>我们访问:<a href="http://127.0.0.1:8010/biz" target="_blank" rel="external">http://127.0.0.1:8010/biz</a><br>结果返回:success<br>查看数据库表时候发现我们表中插入了数据。  </li>
</ol>
<h4 id="3-分布式事务出现情况"><a href="#3-分布式事务出现情况" class="headerlink" title="3.分布式事务出现情况"></a>3.分布式事务出现情况</h4><p>我们分析一下分布式事务会出现在什么情况下?<br>我们在biz服务调用其他两个服务的时候添加以下语句: int i = 1 / 0; 让其报错,这个时候pay/order服务会回滚吗?不会回滚的,因为pay/order是不同的jvm。本地事务是管不到其他jvm里面的(进程之间事务不具有传递性)。  </p>
<p>我们重启:biz-service,然后访问:<a href="http://127.0.0.1:8010/biz" target="_blank" rel="external">http://127.0.0.1:8010/biz</a><br>此时pay/order服务已经插入了数据  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/05/SpringCloudAlibaba-18-seata分布式事务问题回显/" class="archive-article-date">
  	<time datetime="2020-02-05T08:47:55.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-05</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-17-sentinel整合gateway限流" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/05/SpringCloudAlibaba-17-sentinel整合gateway限流/">SpringCloudAlibaba-17-sentinel整合gateway限流</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本节主要讲解sentinel整合gateway网关  </p>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/35.png" alt=""><br>sentinel支持以下两种模式的限流<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/36.png" alt="">  </p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><h5 id="1-创建网关"><a href="#1-创建网关" class="headerlink" title="1.创建网关"></a>1.创建网关</h5><ol>
<li>1.创建一个非web依赖的工程:sentinel-gateway  </li>
<li>2.作为一个网关，需要使用sentinel限流,并且注册到nacos上，需要引入出基本的spring cloud组件后,需要再次引入：sentinel依赖，服务发现依赖，网关依赖，网关和sentinel结合依赖。  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;!--gateway--&gt;</div><div class="line">       &lt;dependency&gt;</div><div class="line">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">           &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</div><div class="line">       &lt;/dependency&gt;</div><div class="line">       &lt;!--服务发现--&gt;</div><div class="line">       &lt;dependency&gt;</div><div class="line">           &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</div><div class="line">           &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</div><div class="line">       &lt;/dependency&gt;</div><div class="line">       &lt;!--sentinel--&gt;</div><div class="line">       &lt;dependency&gt;</div><div class="line">           &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</div><div class="line">           &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</div><div class="line">       &lt;/dependency&gt;</div><div class="line">       &lt;!--sentinel和gateway整合--&gt;</div><div class="line">       &lt;dependency&gt;</div><div class="line">           &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</div><div class="line">           &lt;artifactId&gt;spring-cloud-alibaba-sentinel-gateway&lt;/artifactId&gt;</div><div class="line">       &lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ol>
<li>3.配置文件定义  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">server:</div><div class="line">  port: 18084</div><div class="line">spring:</div><div class="line">  application:</div><div class="line">    name: sentinel-gateway</div><div class="line">  cloud:</div><div class="line">    nacos:</div><div class="line">      discovery:</div><div class="line">        server-addr: 127.0.0.1:8848</div><div class="line">    sentinel:</div><div class="line">      transport:</div><div class="line">        dashboard: 127.0.0.1:8080</div><div class="line">        #配置降级策略</div><div class="line">      scg:</div><div class="line">        fallback:</div><div class="line">          mode: response</div><div class="line">          response-status: 426</div><div class="line">          response-body: error request</div><div class="line">    #gateway路由规则</div><div class="line">    gateway:</div><div class="line">      routes:</div><div class="line">        - id: test_route</div><div class="line">          uri: lb://sentinel-gateway-service</div><div class="line">          predicates:</div><div class="line">            - Path=/test/**</div></pre></td></tr></table></figure>
<ol>
<li>4.启动类添加注解:@SpringCloudApplication  </li>
</ol>
<h5 id="2-创建网关下游的服务"><a href="#2-创建网关下游的服务" class="headerlink" title="2.创建网关下游的服务"></a>2.创建网关下游的服务</h5><ol>
<li>1.创建一个非web依赖的工程:sentinel-gateway-service    </li>
<li>2.作为一个网关下测试服务，需要注册到nacos上。 </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;!--服务发现--&gt;</div><div class="line">       &lt;dependency&gt;</div><div class="line">           &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</div><div class="line">           &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</div><div class="line">       &lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ol>
<li>3.配置文件定义  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line">  application:</div><div class="line">    name: sentinel-gateway-service</div><div class="line">  cloud:</div><div class="line">    nacos:</div><div class="line">      discovery:</div><div class="line">        server-addr: 127.0.0.1:8848</div><div class="line">server:</div><div class="line">  port: 18086</div></pre></td></tr></table></figure>
<ol>
<li><p>4.启动类添加注解:@EnableDiscoveryClient、@SpringBootApplication </p>
</li>
<li><p>5.创建测试类:</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@RestController</div><div class="line">public class DemoController &#123;</div><div class="line">    /**</div><div class="line">     * 因为在gateway中路由规则,都是test的会被拦截</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    @GetMapping(&quot;/test&quot;)</div><div class="line">    public String test()&#123;</div><div class="line">        return &quot;test&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-访问网关路由到对应的下游服务"><a href="#3-访问网关路由到对应的下游服务" class="headerlink" title="3.访问网关路由到对应的下游服务"></a>3.访问网关路由到对应的下游服务</h5><p>访问网关:<a href="http://localhost:18084/test" target="_blank" rel="external">http://localhost:18084/test</a><br>返回:test    </p>
<h5 id="4-结合sentinel进行降级"><a href="#4-结合sentinel进行降级" class="headerlink" title="4.结合sentinel进行降级"></a>4.结合sentinel进行降级</h5><ol>
<li>1.第一种限流规则:针对route</li>
</ol>
<p><a href="http://127.0.0.1:8080/进入登录sentinel" target="_blank" rel="external">http://127.0.0.1:8080/进入登录sentinel</a><br>然后”流控规则”<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/37.png" alt="">  </p>
<p>再次访问:<br><a href="http://localhost:18084/test" target="_blank" rel="external">http://localhost:18084/test</a><br>返回:<br>error request  </p>
<ol>
<li>2.第二种限流规则:API分组限流<br>a.先创建api分组<br>Sentinel 控制台–&gt;API管理–&gt;新建API分组<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/38.png" alt="">  </li>
</ol>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/39.png" alt=""> </p>
<p>再次访问:<br><a href="http://localhost:18084/test" target="_blank" rel="external">http://localhost:18084/test</a><br>返回:<br>error request  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/05/SpringCloudAlibaba-17-sentinel整合gateway限流/" class="archive-article-date">
  	<time datetime="2020-02-05T06:45:23.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-05</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-16-sentinel整合feign实现服务调用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/02/SpringCloudAlibaba-16-sentinel整合feign实现服务调用/">SpringCloudAlibaba-16-sentinel整合feign实现服务调用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>使用sentinel实现服务间的调用,sentinel在这里面作为了是流量防护组件。他结合openfeign实现了服务降级等作用。 以下我们创建结合sentinel和feign的创建2个应用，服务消费方，服务提供方。     </p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><h4 id="服务提供方-provider创建"><a href="#服务提供方-provider创建" class="headerlink" title="服务提供方:provider创建"></a>服务提供方:provider创建</h4><ol>
<li>1.创建spring项目  </li>
<li>2.引入cloud依赖  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;!--依赖版本定义--&gt;</div><div class="line">    &lt;dependencyManagement&gt;</div><div class="line">        &lt;dependencies&gt;</div><div class="line">            &lt;dependency&gt;</div><div class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;Hoxton.RELEASE&lt;/version&gt;</div><div class="line">                &lt;type&gt;pom&lt;/type&gt;</div><div class="line">                &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">            &lt;/dependency&gt;</div><div class="line">            &lt;dependency&gt;</div><div class="line">                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</div><div class="line">                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;</div><div class="line">                &lt;version&gt;2.1.1.RELEASE&lt;/version&gt;</div><div class="line">                &lt;type&gt;pom&lt;/type&gt;</div><div class="line">                &lt;scope&gt;import&lt;/scope&gt;</div><div class="line">            &lt;/dependency&gt;</div><div class="line">        &lt;/dependencies&gt;</div><div class="line">    &lt;/dependencyManagement&gt;</div><div class="line">```  </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">4. 4.使用sentinel、openfeign、discovery</div></pre></td></tr></table></figure>
<p> <dependency><br>    <groupid>com.alibaba.cloud</groupid><br>    <artifactid>spring-cloud-starter-alibaba-nacos-discovery</artifactid><br></dependency></p>
<p><dependency><br>    <groupid>com.alibaba.cloud</groupid><br>    <artifactid>spring-cloud-starter-alibaba-sentinel</artifactid><br></dependency></p>
<p><dependency><br>    <groupid>org.springframework.cloud</groupid><br>    <artifactid>spring-cloud-starter-openfeign</artifactid><br></dependency><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">5. 5.我们是服务提供方,我们书写一个接口</div></pre></td></tr></table></figure></p>
<p>@RestController<br>public class DemoController {<br>    @GetMapping(“/feign”)<br>    public String feign(){<br>        return “hello sentinel feign”;<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">6. 6.启动类添加注解</div></pre></td></tr></table></figure></p>
<p>@SpringCloudApplication<br>public class SentinelFeignProviderApplication {<br>    public static void main(String[] args) {<br>        SpringApplication.run(SentinelFeignProviderApplication.class, args);<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">7. 7.添加配置文件application.yml</div></pre></td></tr></table></figure></p>
<p>server:<br>  port: 18082<br>spring:<br>  application:<br>    name: sentinel-feign-provider<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: 127.0.0.1:8848<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 服务消费方:consumer创建  </div><div class="line">我们复制sentinel-feign-provider修改成 sentinel-feign-consumer  </div><div class="line">启动类上添加注解:@EnableFeignClients  </div><div class="line"></div><div class="line"></div><div class="line">1. 1.创建feign客户端</div></pre></td></tr></table></figure></p>
<p>@FeignClient(value = “sentinel-feign-provider”,fallback =DemoFeignClientFallback.class)<br>public interface DemoFeginClient {<br>    @GetMapping(“/feign”)<br>    String feign();<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">2. 2.创建服务降级实现类</div></pre></td></tr></table></figure></p>
<p>@Component<br>public class DemoFeignClientFallback implements DemoFeginClient {<br>    @Override<br>    public String feign() {<br>        return “error”;<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">3. 3.创建consumer的测试请求类:</div></pre></td></tr></table></figure></p>
<p>@RestController<br>public class DemoController {<br>    @Autowired<br>    private DemoFeginClient demoFeginClient;<br>    @GetMapping(“/hello”)<br>    public String feign(){<br>        return demoFeginClient.feign();<br>    }<br>}<br>```</p>
<p>测试:<br><a href="http://localhost:18083/hello" target="_blank" rel="external">http://localhost:18083/hello</a><br>结果：<br>hello sentinel feign  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/02/SpringCloudAlibaba-16-sentinel整合feign实现服务调用/" class="archive-article-date">
  	<time datetime="2020-02-02T05:08:45.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-02</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-15-sentinel规则持久化-nacos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/02/SpringCloudAlibaba-15-sentinel规则持久化-nacos/">SpringCloudAlibaba-15-sentinel规则持久化-nacos</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1.引入依赖"></a>1.引入依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.7.0&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h4 id="2-application-yml添加配置"><a href="#2-application-yml添加配置" class="headerlink" title="2.application.yml添加配置"></a>2.application.yml添加配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">server:</div><div class="line">  port: 18080</div><div class="line">spring:</div><div class="line">  application:</div><div class="line">    name: sentinel-core-example</div><div class="line">  cloud:</div><div class="line">    sentinel:</div><div class="line">      transport:</div><div class="line">        dashboard: 127.0.0.1:8080</div><div class="line">      datasource:</div><div class="line">        ds1:</div><div class="line">          file:</div><div class="line">            file: classpath:flowrule.json</div><div class="line">            data-type: json</div><div class="line">            rule-type: flow</div><div class="line">        ds2:</div><div class="line">          nacos:</div><div class="line">            server-addr: 127.0.0.0.1:8848</div><div class="line">            dataId: sentinel-core-example</div><div class="line">            groupId: DEFAULT_GROUP</div><div class="line">            data-type: json</div><div class="line">            rule-type: flow</div><div class="line">```  </div><div class="line"></div><div class="line"></div><div class="line">#### 3.启动nacos  </div><div class="line">重启nacos,然后创建sentinel-core-example配置文件  </div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/33.png)  </div><div class="line"></div><div class="line">HellController添加:</div></pre></td></tr></table></figure>
<p>  @GetMapping(“/resource1”)<br>    @SentinelResource(value = “hello2”, blockHandler = “exHandler”, blockHandlerClass = {ExceptionUtil.class})<br>    public String resource1() {<br>        return “hello resource1”;<br>    }<br>```</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/02/SpringCloudAlibaba-15-sentinel规则持久化-nacos/" class="archive-article-date">
  	<time datetime="2020-02-02T04:12:50.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-02</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-14-sentinel规则持久化-file" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>title: SpringCloudAlibaba-14-sentinel规则持久化-file<br>date: 2020-02-02 10:07:44<br>tags:</p>
<h2 id="SpringCloudAlibaba"><a href="#SpringCloudAlibaba" class="headerlink" title=" SpringCloudAlibaba"></a> SpringCloudAlibaba</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>之前的限流及其其他操作，当我们重启应用后,对应的规则在sentinel里面已经丢失不复存在了。现在我们主要说明sentinel参数如何持久化?  </p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><h4 id="1-规则持久化"><a href="#1-规则持久化" class="headerlink" title="1.规则持久化"></a>1.规则持久化</h4><p>目前支持file,nacos,zk,apollo,redis这5种类型<br>如果你想扩展其他的也提供了对应的接口。  </p>
<h4 id="2-规则持久化-file"><a href="#2-规则持久化-file" class="headerlink" title="2.规则持久化-file"></a>2.规则持久化-file</h4><p>我们先讲解规则存放在file里面。  </p>
<ol>
<li>1.在应用程序的resources文件下创建file:flowrule.json  </li>
<li><p>2.填写限流属性规则:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/31.png" alt="">  </p>
</li>
<li><p>3.我们将上面配置添加到配置中去:application.yml    </p>
</li>
</ol>
<pre><code>server:
  port: 18080
spring:
  application:
    name: sentinel-core-example
  cloud:
    sentinel:
      transport:
        dashboard: 127.0.0.1:8080
      datasource:
        ds1:
          file:
            file: classpath:flowrule.json
            data-type: json
            rule-type: flow
</code></pre><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/32.png" alt="">  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/02/SpringCloudAlibaba-14-sentinel规则持久化-file/" class="archive-article-date">
  	<time datetime="2020-02-02T02:07:44.554Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-02</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-13-sentinel自适应限流" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>title: SpringCloudAlibaba-13-sentinel自适应限流<br>date: 2020-02-02 09:18:47<br>tags:</p>
<h2 id="SpringCloudAlibaba"><a href="#SpringCloudAlibaba" class="headerlink" title=" SpringCloudAlibaba"></a> SpringCloudAlibaba</h2><p>参考:<a href="https://www.jianshu.com/p/f1f052413d1c" target="_blank" rel="external">https://www.jianshu.com/p/f1f052413d1c</a>  </p>
<h4 id="1-什么是自适应限流？"><a href="#1-什么是自适应限流？" class="headerlink" title="1.什么是自适应限流？"></a>1.什么是自适应限流？</h4><p>比如说我们设置一个参数的阈值，当超过这个阈值时候，都把所有请求block掉,当低于这个阈值时候,正常处理,比如说:cpu设置70%负载,当超过这个阈值时候，我们系统不处理新的请求，保证业务稳定正常运行。</p>
<h4 id="2-sentinel提供的限流类别"><a href="#2-sentinel提供的限流类别" class="headerlink" title="2.sentinel提供的限流类别"></a>2.sentinel提供的限流类别</h4><p>我们在sentinel控制台上有一个”系统规则”;点击新增时候里面有5个类别设置。  </p>
<ol>
<li>1.LOAD:linux/unix里面瞬间处理的进程数,比如cpu是8核,那么同时只能处理8个进程数。如果超过8会去等待。一般这个参数是:cpu个数x核数x0.7(保证系统70%临界)        </li>
<li>2.RT:平均响应时间,其中RT单位为毫秒,比如我们设置1000ms都挂起,block掉。</li>
<li>3.线程数  </li>
<li>4.入口QPS:全局的qps</li>
<li>5.CPU使用率:一般设置到0.7    </li>
</ol>
<h4 id="3-实践"><a href="#3-实践" class="headerlink" title="3.实践"></a>3.实践</h4><p>我们设置cpu使用率是0.1,测试下效果，因为我们本地的cpu使用率肯定超过了10%<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/29.png" alt="">  </p>
<p>请求后:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/30.png" alt="">  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/02/SpringCloudAlibaba-13-sentinel自适应限流/" class="archive-article-date">
  	<time datetime="2020-02-02T01:18:47.116Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-02</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-12-sentinel热点限流" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/02/SpringCloudAlibaba-12-sentinel热点限流/">SpringCloudAlibaba-12-sentinel热点限流</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我们已经对单机限流和集群限流有过一定了解了，但是他们都是针对一些固定的资源进行流控的，在实际的应用场景中我们可能会遇到各种复杂的情况，不可能通过固定的资源来进行限流。</p>
<p>比如我们想要对一段时间内频繁访问的用户 ID 进行限制，又或者我们想统计一段时间内最常购买的商品 ID 并针对商品 ID 进行限制。那这里的用户 ID 和商品 ID 都是可变的资源，通过原先的固定资源已经无法满足我们的需求了，这时我们就可以通过 Sentinel 为我们提供的 热点参数限流 来达到这样的效果</p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><p>参考:<a href="https://www.jianshu.com/p/2efe5058fcf4" target="_blank" rel="external">https://www.jianshu.com/p/2efe5058fcf4</a>  </p>
<h4 id="1-什么是热点-参数"><a href="#1-什么是热点-参数" class="headerlink" title="1.什么是热点(参数)?"></a>1.什么是热点(参数)?</h4><ol>
<li>首先我们需要知道什么是热点，热点就是访问非常频繁的参数  </li>
<li>例如我们大家都知道的爬虫，就是通过脚本去爬取其他网站的数据，一般防爬虫的常用方法之一就是限制爬虫的 IP，那对应到这里 IP 就是一种热点的参数。  </li>
<li><p>那么 Sentinel 是怎么知道哪些参数是热点，哪些参数不是热点的呢？Sentinel 利用 LRU 策略，结合底层的滑动窗口机制来实现热点参数统计。LRU 策略可以统计单位时间内，最近最常访问的热点参数，而滑动窗口机制可以帮助统计每个参数的 qps。</p>
</li>
<li><p>说简单点就是，Sentinel 会先检查出提交过来的参数，哪些是热点的参数，然后在应用热点参数的限流规则，将qps 超过设定阈值的请求给 block 掉，整个过程如下图所示：<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/25.png" alt="">  </p>
</li>
</ol>
<p>如果参数携带:axb；他的qps大于5,会被阻塞掉  </p>
<h4 id="2-实战"><a href="#2-实战" class="headerlink" title="2.实战"></a>2.实战</h4><ol>
<li>1.我们创建一个ParamController  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@RestController</div><div class="line">public class ParamController &#123;</div><div class="line">    @GetMapping(&quot;/param&quot;)</div><div class="line">    @SentinelResource(value = &quot;param&quot;,blockHandler = &quot;exHandler&quot;)</div><div class="line">    public String param(String type)&#123;</div><div class="line">        return &quot;success&quot;;</div><div class="line">    &#125;</div><div class="line">    public String exHandler(String type)&#123;</div><div class="line">        /**</div><div class="line">         * 热点限流:参数限流</div><div class="line">         * 所以我们需要接受一个参数</div><div class="line">         * 如果不指定blockHandlerClass默认会从本类去寻找处理类:exHandler</div><div class="line">         */</div><div class="line">        return &quot;param request error&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>2.访问<br>curl <a href="http://127.0.0.1:18080/param" target="_blank" rel="external">http://127.0.0.1:18080/param</a><br>然后打开sentinel,我们发现在param下面挂载了一个param资源,此时我们点进去:<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/26.png" alt=""><br>设置热线限流(全部限制):<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/27.png" alt=""></li>
</ol>
<ol>
<li>3.测试访问<br><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/28.png" alt=""></li>
</ol>
<p>注意热线限流不支持接口资源，一定是带有@SentinelResource注解的资源  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/02/SpringCloudAlibaba-12-sentinel热点限流/" class="archive-article-date">
  	<time datetime="2020-02-02T00:22:44.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-02</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-11-sentinel黑白名单控制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>title: SpringCloudAlibaba-11-sentinel黑白名单控制<br>date: 2020-02-02 00:02:07<br>tags:</p>
<h2 id="SpringCloudAlibaba"><a href="#SpringCloudAlibaba" class="headerlink" title=" SpringCloudAlibaba"></a> SpringCloudAlibaba</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>上一节我们讲了sentinel的基于url和基于资源流量控制。<br>这一章节我们说一下黑白名单  </p>
<h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><ol>
<li>1.我们这一节做一个客户端黑白名单访问限制，通过使用ip规则<br>自定义:IpRequestOriginParser实现RequestOriginParser接口:  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class IpRequestOriginParser implements RequestOriginParser &#123;</div><div class="line">    @Override</div><div class="line">    public String parseOrigin(HttpServletRequest request) &#123;</div><div class="line">        return request.getRemoteAddr();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>2.将此配置绑定到Sentinel上去  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@Configuration</div><div class="line">public class SentinelConfig &#123;</div><div class="line">    @PostConstruct</div><div class="line">    public void init()&#123;</div><div class="line">        WebCallbackManager.setUrlBlockHandler(new DemoUrlBlockHandler());</div><div class="line">        WebCallbackManager.setRequestOriginParser(new IpRequestOriginParser());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line"></div><div class="line">3. 3.定义一个SecurityController用作测试</div></pre></td></tr></table></figure>
<p>@RestController<br>public class SecurityController {<br>    @GetMapping(“/white”)<br>    public String white() {<br>        return “hello white”;<br>    }<br>    @GetMapping(“/black”)<br>    public String black() {<br>        return “hello black”;<br>    }<br>}<br>```</p>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/21.png" alt="">  </p>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/22.png" alt="">  </p>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/23.png" alt="">  </p>
<p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/24.png" alt="">  </p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/02/SpringCloudAlibaba-11-sentinel黑白名单控制/" class="archive-article-date">
  	<time datetime="2020-02-01T16:02:07.737Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-02</time>
</a>
      
      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-SpringCloudAlibaba-10-sentinel限流功能使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/01/SpringCloudAlibaba-10-sentinel限流功能使用/">SpringCloudAlibaba-10-sentinel限流功能使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-Sentinel简介"><a href="#1-Sentinel简介" class="headerlink" title="1.Sentinel简介"></a>1.Sentinel简介</h3><p>Sentinel 是什么？<br>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。<br>Sentinel 具有以下特征:  </p>
<ol>
<li>丰富的应用场景：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。  </li>
<li>完备的实时监控：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。  </li>
<li>广泛的开源生态：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。  </li>
<li>完善的 SPI 扩展点：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。  </li>
</ol>
<h3 id="2-Sentinel控制台"><a href="#2-Sentinel控制台" class="headerlink" title="2.Sentinel控制台"></a>2.Sentinel控制台</h3><p><img src="https://raw.githubusercontent.com/startshineye/img/master/2020/02/13.png" alt="">  </p>
<p>我们也可以从官网下载源代码,然后mvn编译打包<br><a href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a>  </p>
<p>初始账号/密码:sentinel/sentinel</p>
<p>登录进去是空的,因为我们没有接入任何应用。  </p>
<h3 id="3-Sentinel接入应用"><a href="#3-Sentinel接入应用" class="headerlink" title="3.Sentinel接入应用"></a>3.Sentinel接入应用</h3><ol>
<li>1.创建Spring Initializr子模块   </li>
<li>2.引入sentinel依赖  </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;2.1.1.RELEASE&lt;/version&gt;</div><div class="line"> &lt;/dependency&gt;</div><div class="line">```   </div><div class="line"></div><div class="line"></div><div class="line">3. 3.配置文件</div></pre></td></tr></table></figure>
<p>server:<br>  port: 18080<br>spring:<br>  application:<br>    name: sentinel-core-example<br>  cloud:<br>    sentinel:<br>      transport:<br>        dashboard: 127.0.0.1:8080<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">4. 4.启动</div><div class="line">启动服务时候,发现sentinel的控制端没有新的消息出现。原因是因为sentinel控制台是一个懒加载,只有当有流量的时候才会显示具有流量的应用。我们创建controller</div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/15.png)  </div><div class="line"></div><div class="line">默认情况下是根据url进行限流的,我们可以设置下流控  </div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/17.png)  </div><div class="line">  </div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/16.png)  </div><div class="line"></div><div class="line">设置为1，说明我们每秒只能访问一次  </div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/18.png)  </div><div class="line"></div><div class="line">5. 5.基于资源限流的我们使用注解:</div></pre></td></tr></table></figure></p>
<p>@GetMapping(“/resource”)<br>    @SentinelResource(“/resource”)<br>    public String resource(){<br>        return “Hello resource”;<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 4.重写基于URL的限流自定义输出    </div><div class="line"></div><div class="line">1. 1.自定义url限流处理器</div></pre></td></tr></table></figure></p>
<p>public class DemoUrlBlockHandler implements UrlBlockHandler {<br>    @Override<br>    public void blocked(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e) throws IOException {<br>        httpServletResponse.getWriter().println(“error  url request”);<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2. 2.我们需要把自定义的DemoUrlBlockHandler添加到Sentinel限流配置中去</div></pre></td></tr></table></figure></p>
<p>@Configuration<br>public class SentinelConfig {<br>    @PostConstruct<br>    public void innit(){<br>        WebCallbackManager.setUrlBlockHandler(new DemoUrlBlockHandler());<br>    }<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">然后我们重启服务,重启服务时候,之前的监控信息会丢失,重新设置流控为0,然后请求，返回如下结果:    </div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/19.png) </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### 4.重写基于资源名称的限流自定义输出  </div><div class="line">通过blockHandler方法名，默认情况下，会找本类下的上面方法,返回值和目标方法一致,也是String,入参和请求的接口入参一致,但是会返回一个BlockException    </div><div class="line">   </div><div class="line">![](https://raw.githubusercontent.com/startshineye/img/master/2020/02/20.png)  </div><div class="line"></div><div class="line">对于每一个资源resource,我们不可能都单独写一个限流的方法，能不能统一写一个统一的类作为限流。blockHandlerClass =&#123;ExceptionUtil.class&#125; 使用上面 blockHandlerClass属性自定义一个ExceptionUtil</div></pre></td></tr></table></figure></p>
<p>public class ExceptionUtil  {<br>    public static String exHandler(BlockException ex) {<br>        return “exHandler error”;<br>    }<br>}<br>```</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2020/02/01/SpringCloudAlibaba-10-sentinel限流功能使用/" class="archive-article-date">
  	<time datetime="2020-02-01T12:33:13.000Z" itemprop="datePublished"><i class="icon-clock"></i>2020-02-01</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloudAlibaba/">SpringCloudAlibaba</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 Startshineye
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/ElasticStack/" style="font-size: 10px;">ElasticStack</a> <a href="/tags/SpringCloud/" style="font-size: 17.5px;">SpringCloud</a> <a href="/tags/SpringCloudAlibaba/" style="font-size: 20px;">SpringCloudAlibaba</a> <a href="/tags/acdgate/" style="font-size: 10px;">acdgate</a> <a href="/tags/ipcc/" style="font-size: 15px;">ipcc</a> <a href="/tags/problem/" style="font-size: 10px;">problem</a> <a href="/tags/work/" style="font-size: 12.5px;">work</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.baidu.com/">baidu</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jd.com/">jd</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">毕业于&lt;br&gt;相信技术可以改变人与人之间的生活&lt;br&gt;码农一枚</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>